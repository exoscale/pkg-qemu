Backport of:

From 2655fffed7a9e765bcb4701dd876e9dab975f289 Mon Sep 17 00:00:00 2001
From: Samuel Thibault <samuel.thibault@ens-lyon.org>
Date: Wed, 8 Jan 2020 00:58:48 +0100
Subject: [PATCH] tcp_emu: Fix oob access

The main loop only checks for one available byte, while we sometimes
need two bytes.
---
 CHANGELOG.md   | 1 +
 src/tcp_subr.c | 7 +++++++
 2 files changed, 8 insertions(+)

#diff --git a/CHANGELOG.md b/CHANGELOG.md
#index 00d0ce2..5cf94a8 100644
#--- a/CHANGELOG.md
#+++ b/CHANGELOG.md
#@@ -20,6 +20,7 @@ and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0
# ### Fixed
# 
#  - ncsi: fix checksum OOB memory access
#+ - `tcp_emu()`: fix OOB accesses
# 
# ## [4.1.0] - 2019-12-02
# 
--- a/slirp/tcp_subr.c
+++ b/slirp/tcp_subr.c
@@ -895,6 +895,9 @@ tcp_emu(struct socket *so, struct mbuf *
 				break;
 
 			 case 5:
+				if (bptr == m->m_data + m->m_len - 1)
+				   return 1; /* We need two bytes */
+
 				/*
 				 * The difference between versions 1.0 and
 				 * 2.0 is here. For future versions of
@@ -910,6 +913,10 @@ tcp_emu(struct socket *so, struct mbuf *
 				/* This is the field containing the port
 				 * number that RA-player is listening to.
 				 */
+
+				if (bptr == m->m_data + m->m_len - 1)
+				   return 1; /* We need two bytes */
+
 				lport = (((u_char*)bptr)[0] << 8)
 				+ ((u_char *)bptr)[1];
 				if (lport < 6970)
